name: Update Checker
env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TARGET_REPO: fgbfg5676/immortalwrt   # ðŸ”´ æŒ‡å‘ä½ çš„ fork ä»“åº“
  UPSTREAM_REPO: immortalwrt/immortalwrt
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */18 * * *'   # æ¯18å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: Get Upstream Commit Hash
      id: getHash
      run: |
        # ä½¿ç”¨ ls-remote èŽ·å–æœ€æ–°æäº¤å“ˆå¸Œï¼Œæ— éœ€å…‹éš†æ•´ä¸ªä»“åº“
        echo "commitHash=$(git ls-remote $REPO_URL refs/heads/$REPO_BRANCH | cut -f1)" >> $GITHUB_OUTPUT
        echo "Current upstream commit: $commitHash"
    
    - name: Check for New Commits
      id: checkCommits
      uses: actions/cache@v3
      with:
        path: .commitHash
        key: upstream-commit-${{ steps.getHash.outputs.commitHash }}
        restore-keys: |
          upstream-commit-
    
    - name: Save New Commit Hash
      if: steps.checkCommits.outputs.cache-hit != 'true'
      run: |
        echo "${{ steps.getHash.outputs.commitHash }}" > .commitHash
        echo "New commit detected: ${{ steps.getHash.outputs.commitHash }}"
    
    - name: Trigger Build Workflow
      if: steps.checkCommits.outputs.cache-hit != 'true'
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ secrets.TARGET_REPO_PAT }}          # ðŸ”´ ä½ çš„ PAT
        repository: ${{ env.TARGET_REPO }}             # ðŸ”´ ä½ çš„ fork
        event-type: "Source Code Update"
        client-payload: |
          {
            "upstream_repo": "${{ env.UPSTREAM_REPO }}",
            "upstream_branch": "${{ env.REPO_BRANCH }}",
            "commit_hash": "${{ steps.getHash.outputs.commitHash }}"
          }
    
    - name: Cleanup Old Workflow Runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3
    
    - name: Notify Update Status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: |
          Update check ${{ job.status }}
          ${{ steps.checkCommits.outputs.cache-hit != 'true' && 'New update found and build triggered!' || 'No new updates found.' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
