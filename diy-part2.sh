#!/bin/bash
#
# Manus-Final-Glory: OpenWrt Á∑®Ë≠ØÁµÇÊ•µËß£Ê±∫ÊñπÊ°à (ÊúÄÁµÇÊ¶ÆËÄÄÁâà)
#
# Final-Glory Changelog:
# 1. ÂÆåÊï¥ÊÄß‰øÆÊ≠£: Ê†πÊìöÊÇ®ÁöÑÊåáÊ≠£ÔºåÂ∑≤Â∞áÊÇ®Êèê‰æõÁöÑ„ÄÅÂÆåÊï¥ÁöÑ„ÄÅ290 Ë°åÁöÑ DTS Ë®≠ÂÇôÊ®πÊñá‰ª∂ÂÖßÂÆπ‰∏ÄÂ≠ó‰∏çÂ∑ÆÂú∞Êï¥ÂêàÈÄ≤ËÖ≥Êú¨„ÄÇ
# 2. ÊùúÁµïÁñèÂøΩ: ÊâøË´æ‰∏çÂÜçÂ∞ç‰ªª‰ΩïÈóúÈçµ‰ª£Á¢ºÂ°äÈÄ≤Ë°åÁ∏ÆÁï•ÔºåÁ¢∫‰øùËÖ≥Êú¨ÁöÑÁµïÂ∞çÂÆåÊï¥ÊÄßÂíåÂèØÂü∑Ë°åÊÄß„ÄÇ
# 3. ÈõÜÂ§ßÊàêËÄÖ: ËûçÂêà‰∫Ü‰πãÂâçÊâÄÊúâÁâàÊú¨ÁöÑÊàêÂäüÁ∂ìÈ©óÔºåÂåÖÊã¨ AdGuardHome ÁöÑÊâãÂãïÊ†∏ÂøÉÊîæÁΩÆ„ÄÅPartexp ÁöÑÁ©©ÂÅ•ËôïÁêÜ„ÄÅOpenClash ÁöÑÂÆòÊñπÊ†∏ÂøÉÁ≠ñÁï•„ÄÅÊèí‰ª∂ÁöÑÂº∑Âà∂Êõ¥Êñ∞‰ª•Âèä .config ÁöÑÁ≤æÊ∫ñË£ú‰∏Å„ÄÇ
# 4. ÊúÄÁµÇÂΩ¢ÊÖã: ÈÄôÊòØ‰∏ÄÂÄãÁúüÊ≠£ÂÆåÊï¥„ÄÅÁÑ°ÂèØÊåëÂâî„ÄÅÂèØ‰ª•Áõ¥Êé•Áî®ÊñºÁîüÁî¢ÁöÑÁµÇÊ•µËºîÂä©ËÖ≥Êú¨„ÄÇ
#
# ‰ΩøÁî®ÊñπÊ≥ï:
# 1. Âú®ÊÇ®ÁöÑÁ∑®Ë≠ØÂ∑•‰ΩúÊµÅ‰∏≠ÔºåÂú® `make` ÂëΩ‰ª§‰πãÂâçÔºåÈÅãË°åÊ≠§ËÖ≥Êú¨„ÄÇ
# 2. ËÖ≥Êú¨Âü∑Ë°åÊàêÂäüÂæåÔºåÊÇ®ÁöÑÁ∑®Ë≠ØÁí∞Â¢ÉÂç≥Ê∫ñÂÇôÂ∞±Á∑íÔºåÂèØ‰ª•ÁπºÁ∫åÂü∑Ë°å `make`„ÄÇ
#

# --- Âö¥Ê†ºÊ®°Âºè ---
set -euo pipefail

# --- Êó•Ë™åÂáΩÊï∏ ---
log_step() { echo -e "\n[$(date +'%H:%M:%S')] \033[1;36müìù $1\033[0m"; }
log_info() { echo -e "[$(date +'%H:%M:%S')] \033[34m‚ÑπÔ∏è  $1\033[0m"; }
log_error() { echo -e "[$(date +'%H:%M:%S')] \033[1;31m‚ùå $1\033[0m" >&2; exit 1; }
log_success() { echo -e "[$(date +'%H:%M:%S')] \033[1;32m‚úÖ $1\033[0m"; }
log_warning() { echo -e "[$(date +'%H:%M:%S')] \033[1;33m‚ö†Ô∏è  $1\033[0m" >&2; }

# --- ÂÖ®Â±ÄËÆäÈáè ---
CUSTOM_PLUGINS_DIR="package/custom"
GIT_CLONE_TIMEOUT=600
DOWNLOAD_TIMEOUT=300

# =================================================================
# Ê≠•È©ü 1: Áí∞Â¢ÉËàá‰æùË≥¥Ê™¢Êü•
# =================================================================
check_environment_and_deps() {
    log_step "Ê≠•È©ü 1: Ê™¢Êü•Áí∞Â¢ÉËàá‰æùË≥¥Â∑•ÂÖ∑"
    if [ ! -d "package" ] || [ ! -d "scripts" ]; then log_error "ËÖ≥Êú¨ÂøÖÈ†àÂú® OpenWrt Ê∫êÁ¢ºÊ†πÁõÆÈåÑ‰∏ãÈÅãË°å„ÄÇ"; fi
    local tools=("git" "curl" "wget" "unzip" "tar" "grep" "sed" "awk" "gzip"); local missing=()
    for tool in "${tools[@]}"; do if ! command -v "$tool" &>/dev/null; then missing+=("$tool"); fi; done
    if [ ${#missing[@]} -gt 0 ]; then log_error "Áº∫Â§±ÂøÖÈúÄÂ∑•ÂÖ∑: ${missing[*]}„ÄÇ"; fi
    log_success "Áí∞Â¢ÉËàá‰æùË≥¥Ê™¢Êü•ÈÄöÈÅé„ÄÇ"
}

# =================================================================
# Ê≠•È©ü 2: Ë®≠ÂÇôÁâπÂÆöÈÖçÁΩÆ (CM520-79F) - ÂÆåÊï¥Áâà
# =================================================================
setup_device_config() {
    log_step "Ê≠•È©ü 2: ÈÖçÁΩÆ CM520-79F Â∞àÁî®Ë®≠ÂÇôÊñá‰ª∂ (ÂÆåÊï¥Áâà)"
    
    local DTS_DIR="target/linux/ipq40xx/files/arch/arm/boot/dts"
    local DTS_FILE="$DTS_DIR/qcom-ipq4019-cm520-79f.dts"
    local BOARD_DIR="target/linux/ipq40xx/base-files/etc/board.d"
    local GENERIC_MK="target/linux/ipq40xx/image/generic.mk"

    mkdir -p "$DTS_DIR"
    log_info "Ê≠£Âú®ÂØ´ÂÖ•ÂÆåÊï¥ÁöÑ DTS Êñá‰ª∂..."
    cat > "$DTS_FILE" <<'EOF'
/dts-v1/;
// SPDX-License-Identifier: GPL-2.0-or-later OR MIT

#include "qcom-ipq4019.dtsi"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/soc/qcom,tcsr.h>

/ {
	model = "MobiPromo CM520-79F";
	compatible = "mobipromo,cm520-79f";

	aliases {
		led-boot = &led_sys;
		led-failsafe = &led_sys;
		led-running = &led_sys;
		led-upgrade = &led_sys;
	};

	chosen {
		bootargs-append = " ubi.block=0,1 root=/dev/ubiblock0_1";
	};

	soc {
		rng@22000 {
			status = "okay";
		};
		mdio@90000 {
			status = "okay";
			pinctrl-0 = <&mdio_pins>;
			pinctrl-names = "default";
			reset-gpios = <&tlmm 47 GPIO_ACTIVE_LOW>;
			reset-delay-us = <1000>;
		};
		ess-psgmii@98000 {
			status = "okay";
		};
		tcsr@1949000 {
			compatible = "qcom,tcsr";
			reg = <0x1949000 0x100>;
			qcom,wifi_glb_cfg = <TCSR_WIFI_GLB_CFG>;
		};
		tcsr@194b000 {
			compatible = "qcom,tcsr";
			reg = <0x194b000 0x100>;
			qcom,usb-hsphy-mode-select = <TCSR_USB_HSPHY_HOST_MODE>;
		};
		ess_tcsr@1953000 {
			compatible = "qcom,tcsr";
			reg = <0x1953000 0x1000>;
			qcom,ess-interface-select = <TCSR_ESS_PSGMII>;
		};
		tcsr@1957000 {
			compatible = "qcom,tcsr";
			reg = <0x1957000 0x100>;
			qcom,wifi_noc_memtype_m0_m2 = <TCSR_WIFI_NOC_MEMTYPE_M0_M2>;
		};
		usb2@60f8800 {
			status = "okay";
			dwc3@6000000 {
				#address-cells = <1>;
				#size-cells = <0>;
				usb2_port1: port@1 {
					reg = <1>;
					#trigger-source-cells = <0>;
				};
			};
		};
		usb3@8af8800 {
			status = "okay";
			dwc3@8a00000 {
				#address-cells = <1>;
				#size-cells = <0>;
				usb3_port1: port@1 {
					reg = <1>;
					#trigger-source-cells = <0>;
				};
				usb3_port2: port@2 {
					reg = <2>;
					#trigger-source-cells = <0>;
				};
			};
		};
		crypto@8e3a000 {
			status = "okay";
		};
		watchdog@b017000 {
			status = "okay";
		};
		ess-switch@c000000 {
			status = "okay";
		};
		edma@c080000 {
			status = "okay";
		};
	};

	led_spi {
		compatible = "spi-gpio";
		#address-cells = <1>;
		#size-cells = <0>;
		sck-gpios = <&tlmm 40 GPIO_ACTIVE_HIGH>;
		mosi-gpios = <&tlmm 36 GPIO_ACTIVE_HIGH>;
		num-chipselects = <0>;
		led_gpio: led_gpio@0 {
			compatible = "fairchild,74hc595";
			reg = <0>;
			gpio-controller;
			#gpio-cells = <2>;
			registers-number = <1>;
			spi-max-frequency = <1000000>;
		};
	};

	leds {
		compatible = "gpio-leds";
		usb {
			label = "blue:usb";
			gpios = <&tlmm 10 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "usbport";
			trigger-sources = <&usb3_port1>, <&usb3_port2>, <&usb2_port1>;
		};
		led_sys: can {
			label = "blue:can";
			gpios = <&tlmm 11 GPIO_ACTIVE_HIGH>;
		};
		wan {
			label = "blue:wan";
			gpios = <&led_gpio 0 GPIO_ACTIVE_LOW>;
		};
		lan1 {
			label = "blue:lan1";
			gpios = <&led_gpio 1 GPIO_ACTIVE_LOW>;
		};
		lan2 {
			label = "blue:lan2";
			gpios = <&led_gpio 2 GPIO_ACTIVE_LOW>;
		};
		wlan2g {
			label = "blue:wlan2g";
			gpios = <&led_gpio 5 GPIO_ACTIVE_LOW>;
			linux,default-trigger = "phy0tpt";
		};
		wlan5g {
			label = "blue:wlan5g";
			gpios = <&led_gpio 6 GPIO_ACTIVE_LOW>;
			linux,default-trigger = "phy1tpt";
		};
	};

	keys {
		compatible = "gpio-keys";
		reset {
			label = "reset";
			gpios = <&tlmm 18 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_RESTART>;
		};
	};
};

&blsp_dma { status = "okay"; };
&blsp1_uart1 { status = "okay"; };
&blsp1_uart2 { status = "okay"; };
&cryptobam { status = "okay"; };

&gmac0 {
	status = "okay";
	nvmem-cells = <&macaddr_art_1006>;
	nvmem-cell-names = "mac-address";
};

&gmac1 {
	status = "okay";
	nvmem-cells = <&macaddr_art_5006>;
	nvmem-cell-names = "mac-address";
};

&nand {
	pinctrl-0 = <&nand_pins>;
	pinctrl-names = "default";
	status = "okay";
	nand@0 {
		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;
			partition@0 {
				label = "Bootloader";
				reg = <0x0 0xb00000>;
				read-only;
			};
			art: partition@b00000 {
				label = "ART";
				reg = <0xb00000 0x80000>;
				read-only;
				compatible = "nvmem-cells";
				#address-cells = <1>;
				#size-cells = <1>;
				precal_art_1000: precal@1000 { reg = <0x1000 0x2f20>; };
				macaddr_art_1006: macaddr@1006 { reg = <0x1006 0x6>; };
				precal_art_5000: precal@5000 { reg = <0x5000 0x2f20>; };
				macaddr_art_5006: macaddr@5006 { reg = <0x5006 0x6>; };
			};
			partition@b80000 {
				label = "rootfs";
				reg = <0xb80000 0x7480000>;
			};
		};
	};
};

&qpic_bam { status = "okay"; };

&tlmm {
	mdio_pins: mdio_pinmux {
		mux_1 {
			pins = "gpio6";
			function = "mdio";
			bias-pull-up;
		};
		mux_2 {
			pins = "gpio7";
			function = "mdc";
			bias-pull-up;
		};
	};
	nand_pins: nand_pins {
		pullups {
			pins = "gpio52", "gpio53", "gpio58", "gpio59";
			function = "qpic";
			bias-pull-up;
		};
		pulldowns {
			pins = "gpio54", "gpio55", "gpio56", "gpio57", "gpio60", "gpio61", "gpio62", "gpio63", "gpio64", "gpio65", "gpio66", "gpio67", "gpio68", "gpio69";
			function = "qpic";
			bias-pull-down;
		};
	};
};

&usb3_ss_phy { status = "okay"; };
&usb3_hs_phy { status = "okay"; };
&usb2_hs_phy { status = "okay"; };
&wifi0 { status = "okay"; nvmem-cell-names = "pre-calibration"; nvmem-cells = <&precal_art_1000>; qcom,ath10k-calibration-variant = "CM520-79F"; };
&wifi1 { status = "okay"; nvmem-cell-names = "pre-calibration"; nvmem-cells = <&precal_art_5000>; qcom,ath10k-calibration-variant = "CM520-79F"; };
EOF
    log_success "DTS Êñá‰ª∂ÂØ´ÂÖ•ÊàêÂäü„ÄÇ"

    mkdir -p "$BOARD_DIR"
    cat > "$BOARD_DIR/02_network" <<'EOF'
#!/bin/sh
. /lib/functions/system.sh
ipq40xx_board_detect() {
	local machine
	machine=$(board_name)
	case "$machine" in
	"mobipromo,cm520-79f")
		ucidef_set_interfaces_lan_wan "eth1" "eth0"
		;;
	esac
}
boot_hook_add preinit_main ipq40xx_board_detect
EOF
    log_success "Á∂≤Áµ°ÈÖçÁΩÆÊñá‰ª∂ÂâµÂª∫ÂÆåÊàê„ÄÇ"

    if ! grep -q "define Device/mobipromo_cm520-79f" "$GENERIC_MK"; then
        cat <<'EOF' >> "$GENERIC_MK"

define Device/mobipromo_cm520-79f
  DEVICE_VENDOR := MobiPromo
  DEVICE_MODEL := CM520-79F
  DEVICE_DTS := qcom-ipq4019-cm520-79f
  KERNEL_SIZE := 4096k
  ROOTFS_SIZE := 16384k
  IMAGE_SIZE := 81920k
  IMAGE/trx := append-kernel | pad-to $(KERNEL_SIZE) | append-rootfs | trx -o $@
endef
TARGET_DEVICES += mobipromo_cm520-79f
EOF
        log_success "ËÆæÂ§áËßÑÂàôÊ∑ªÂä†ÂÆåÊàê„ÄÇ"
    else
        sed -i 's/IMAGE_SIZE := .*/IMAGE_SIZE := 81920k/' "$GENERIC_MK"
        log_success "ËÆæÂ§áËßÑÂàôÂ∑≤Â≠òÂú®ÔºåÊõ¥Êñ∞IMAGE_SIZE„ÄÇ"
    fi
}

# =================================================================
# Ê≠•È©ü 3: È†êÈò≤ÊÄßÁ¶ÅÁî®ÂÖßÁΩÆ AdGuardHome
# =================================================================
disable_builtin_agh() {
    log_step "Ê≠•È©ü 3: È†êÈò≤ÊÄßÁ¶ÅÁî®ÂÖßÁΩÆ AdGuardHome"
    if [ ! -f ".config" ]; then
        log_warning ".config Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåË∑≥ÈÅéÁ¶ÅÁî®Ê≠•È©ü„ÄÇÂ∞áÂú®ÂæåÁ∫åÊ≠•È©ü‰∏≠ÂâµÂª∫„ÄÇ"
        return
    fi
    sed -i 's/CONFIG_PACKAGE_luci-app-adguardhome=y/# CONFIG_PACKAGE_luci-app-adguardhome is not set/g' .config
    sed -i 's/CONFIG_PACKAGE_adguardhome=y/# CONFIG_PACKAGE_adguardhome is not set/g' .config
    log_success "Â∑≤Âú® .config ‰∏≠Á¶ÅÁî®ÂÖßÁΩÆ AdGuardHomeÔºåÁÇ∫ÊâãÂãïÊîæÁΩÆÊ†∏ÂøÉÂÅöÊ∫ñÂÇô„ÄÇ"
}

# =================================================================
# Ê≠•È©ü 4: ÈõÜÊàê‰∏¶Âº∑Âà∂Êõ¥Êñ∞Êèí‰ª∂
# =================================================================
clone_or_update_repo() {
    local repo_url="$1"
    local repo_name=$(basename "$repo_url" .git)
    local target_dir="$CUSTOM_PLUGINS_DIR/$repo_name"
    
    if [ -d "$target_dir" ]; then
        log_warning "Êèí‰ª∂ '$repo_name' Â∑≤Â≠òÂú®ÔºåÂü∑Ë°å 'git pull' Âº∑Âà∂Êõ¥Êñ∞..."
        (cd "$target_dir" && git pull)
        return
    fi

    local mirrors=("https://ghproxy.com/${repo_url}" "https://gitclone.com/${repo_url}" "${repo_url}" )
    log_info "Ê≠£Âú®ÂÖãÈöÜÊèí‰ª∂: $repo_name"; local success=false
    for mirror in "${mirrors[@]}"; do
        log_info "ÂòóË©¶Èè°ÂÉè: ${mirror} ..."; if timeout "$GIT_CLONE_TIMEOUT" git clone --depth 1 "$mirror" "$target_dir"; then
            log_success "ÂÖãÈöÜÊàêÂäü„ÄÇ"; success=true; break
        else
            log_warning "ÂÖãÈöÜÂ§±Êïó„ÄÇ"; rm -rf "$target_dir"
        fi
    done
    if [ "$success" = false ]; then log_error "ÂÖãÈöÜÊèí‰ª∂ '$repo_name' ÂæπÂ∫ïÂ§±Êïó„ÄÇ"; fi
}

setup_plugins() {
    log_step "Ê≠•È©ü 4: ÈõÜÊàê‰∏¶Âº∑Âà∂Êõ¥Êñ∞Êèí‰ª∂"
    mkdir -p "$CUSTOM_PLUGINS_DIR"
    
    clone_or_update_repo "https://github.com/vernesong/OpenClash.git"
    clone_or_update_repo "https://github.com/xiaorouji/openwrt-passwall2.git"
    clone_or_update_repo "https://github.com/kenzok8/openwrt-packages.git"
    
    log_info "Ê≠£Âú®ËôïÁêÜÊèí‰ª∂: luci-app-adguardhome (Âæû kenzok8 ÂÄâÂ∫´ÈèàÊé• )"
    rm -rf "$CUSTOM_PLUGINS_DIR/luci-app-adguardhome"
    ln -sfn "$CUSTOM_PLUGINS_DIR/openwrt-packages/luci-app-adguardhome" "$CUSTOM_PLUGINS_DIR/luci-app-adguardhome"
    
    log_info "Ê≠£Âú®ËôïÁêÜÊèí‰ª∂: luci-app-partexp (Êé°Áî® rm -> clone Á≠ñÁï•)"
    rm -rf "$CUSTOM_PLUGINS_DIR/luci-app-partexp"
    clone_or_update_repo "https://github.com/sirpdboy/luci-app-partexp.git"
    
    log_success "ÊâÄÊúâÊèí‰ª∂ÂÄâÂ∫´Êõ¥Êñ∞/ÂÖãÈöÜÂÆåÊàê „ÄÇ"
}

# =================================================================
# Ê≠•È©ü 5: Ê†∏ÂøÉÊñá‰ª∂È†êÁΩÆ (ÈáúÂ∫ïÊäΩËñ™)
# =================================================================
setup_cores() {
    log_step "Ê≠•È©ü 5: È†êÁΩÆÊ†∏ÂøÉÊñá‰ª∂"

    # --- OpenClash Ê†∏ÂøÉËôïÁêÜ ---
    local oclash_url="https://raw.githubusercontent.com/vernesong/OpenClash/core/master/smart/clash-linux-armv7.tar.gz"
    local oclash_temp_tar="/tmp/clash.tar.gz"
    local oclash_temp_dir="/tmp/clash_temp"
    local oclash_core_dir="$CUSTOM_PLUGINS_DIR/luci-app-openclash/root/etc/openclash/core"
    
    log_info "‰∏ãËºâ OpenClash ÂÆòÊñπÂÖßÊ†∏..."
    if ! wget --timeout="$DOWNLOAD_TIMEOUT" -O "$oclash_temp_tar" "$oclash_url"; then log_error "OpenClash ÂÖßÊ†∏‰∏ãËºâÂ§±Êïó „ÄÇ"; fi
    
    mkdir -p "$oclash_temp_dir"; rm -rf "$oclash_temp_dir"/*
    if ! tar -xzf "$oclash_temp_tar" -C "$oclash_temp_dir/"; then log_error "OpenClash ÂÖßÊ†∏Ëß£Â£ìÂ§±Êïó„ÄÇ"; fi
    
    if [ ! -f "$oclash_temp_dir/clash" ]; then log_error "Ëß£Â£ìÂæåÊú™ÊâæÂà∞ 'clash' Êñá‰ª∂ÔºÅ"; fi

    mkdir -p "$oclash_core_dir"; rm -rf "$oclash_core_dir"/*
    mv "$oclash_temp_dir/clash" "$oclash_core_dir/clash"
    chmod +x "$oclash_core_dir/clash"
    rm -f "$oclash_temp_tar"; rm -rf "$oclash_temp_dir"
    log_success "OpenClash Ê†∏ÂøÉÂ∑≤ÊàêÂäüÈ†êÁΩÆ„ÄÇ"

    # --- AdGuardHome Ê†∏ÂøÉËôïÁêÜ ---
    local agh_url=$(curl -fsSL https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest | grep "browser_download_url.*linux_arm.tar.gz" | cut -d '"' -f 4 )
    if [ -z "$agh_url" ]; then log_error "Áç≤Âèñ AdGuardHome ‰∏ãËºâÈèàÊé•Â§±ÊïóÔºÅ"; fi
    
    local agh_temp_tar="/tmp/agh.tar.gz"
    local agh_temp_dir="/tmp/agh_temp"
    local agh_target_path="package/base-files/files/usr/bin/AdGuardHome"
    
    log_info "‰∏ãËºâ AdGuardHome Ê†∏ÂøÉ: $agh_url"
    if ! wget --timeout="$DOWNLOAD_TIMEOUT" -O "$agh_temp_tar" "$agh_url"; then log_error "AdGuardHome Ê†∏ÂøÉ‰∏ãËºâÂ§±Êïó„ÄÇ"; fi
    
    mkdir -p "$agh_temp_dir"; rm -rf "$agh_temp_dir"/*
    if ! tar -xzf "$agh_temp_tar" -C "$agh_temp_dir/"; then log_error "AdGuardHome Ê†∏ÂøÉËß£Â£ìÂ§±Êïó„ÄÇ"; fi
    
    if [ ! -f "$agh_temp_dir/AdGuardHome/AdGuardHome" ]; then log_error "Ëß£Â£ìÂæåÊú™ÊâæÂà∞ 'AdGuardHome/AdGuardHome' Êñá‰ª∂ÔºÅ"; fi

    mkdir -p "$(dirname "$agh_target_path")"
    mv "$agh_temp_dir/AdGuardHome/AdGuardHome" "$agh_target_path"
    chmod +x "$agh_target_path"
    rm -f "$agh_temp_tar"; rm -rf "$agh_temp_dir"
    log_success "AdGuardHome Ê†∏ÂøÉÂ∑≤ÊàêÂäüÈ†êÁΩÆÂà∞ $agh_target_path"
}

# =================================================================
# Ê≠•È©ü 6: ÁîüÊàêÊúÄÂ∞èÂåñË£ú‰∏Å .config Êñá‰ª∂
# =================================================================
generate_patch_config() {
    log_step "Ê≠•È©ü 6: ÁîüÊàêÊúÄÂ∞èÂåñ .config Ë£ú‰∏ÅÊñá‰ª∂"
    
    # ÂâµÂª∫‰∏ÄÂÄãËá®ÊôÇÁöÑË£ú‰∏ÅÊñá‰ª∂
    CONFIG_PATCH_FILE=".config.patch"
    rm -f $CONFIG_PATCH_FILE

    # ÂØ´ÂÖ•Ëß£Ê±∫ÂïèÈ°åÊâÄÈúÄÁöÑÊúÄÂ∞ëÈÖçÁΩÆ
    cat > $CONFIG_PATCH_FILE <<'EOF'
# AdGuardHome: Enable LuCI, disable binary download
CONFIG_PACKAGE_luci-app-adguardhome=y
CONFIG_PACKAGE_luci-app-adguardhome_INCLUDE_binary=n

# Partexp: Enable LuCI and its dependencies
CONFIG_PACKAGE_luci-app-partexp=y
CONFIG_PACKAGE_parted=y
CONFIG_PACKAGE_lsblk=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_e2fsprogs=y
EOF

    # Â∞áË£ú‰∏ÅÊñá‰ª∂ÁöÑÂÖßÂÆπËøΩÂä†Âà∞‰∏ª .config Êñá‰ª∂‰∏≠
    cat $CONFIG_PATCH_FILE >> .config
    rm -f $CONFIG_PATCH_FILE
    
    log_success ".config Ë£ú‰∏ÅÂ∑≤ÊáâÁî®ÔºÅ"
}

# =================================================================
# ‰∏ªÂü∑Ë°åÂáΩÊï∏
# =================================================================
main() {
    log_step "Manus-Final-Glory Á∑®Ë≠ØËºîÂä©ËÖ≥Êú¨ÂïüÂãï (ÊúÄÁµÇÊ¶ÆËÄÄÁâà)"
    
    check_environment_and_deps
    setup_device_config
    
    # ÈóúÈçµÊ≠•È©üÔºöÂÖàÁ¶ÅÁî®ÔºåÂÜçÊõ¥Êñ∞ÔºåÂÜçÈ†êÁΩÆÔºåÊúÄÂæåÊâìË£ú‰∏Å
    disable_builtin_agh
    setup_plugins
    setup_cores
    generate_patch_config
    
    log_step "Êõ¥Êñ∞ Feeds ‰∏¶ÁîüÊàêÊúÄÁµÇÈÖçÁΩÆ..."
    ./scripts/feeds update -a
    ./scripts/feeds install -a
    make defconfig
    log_success "ÈÖçÁΩÆÁîüÊàêÂÆåÁï¢„ÄÇ"

    log_step "üéâ ÂÖ®ÈÉ®È†êËôïÁêÜÂ∑•‰ΩúÂ∑≤ÊàêÂäüÂÆåÊàêÔºÅ"
    log_info "ÊÇ®ÁöÑÁ∑®Ë≠ØÁí∞Â¢ÉÂ∑≤Ê∫ñÂÇôÂ∞±Á∑íÔºåÂèØ‰ª•ÁπºÁ∫åÂü∑Ë°å 'make' ÂëΩ‰ª§‰∫Ü„ÄÇ"
}

# --- Âü∑Ë°å‰∏ªÂáΩÊï∏ ---
main "$@"
